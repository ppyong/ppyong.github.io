---
layout: post
title: JPA 정리
---

## 영속성 컨텍스트

> 엔티티를 영구 저장하는 환경이라는 뜻. 엔티티 매니저를 생성할 때 하나 만들어지고, 매니저를 통해서 영속성 컨텍스트에 접근할 수 있다. 

&nbsp;
## 엔티티 생명 주기 

- 비영속(new/transient)

>  엔티티 객체를 생성 후 아직 저장하지 않은 상태. 영속성 컨텍스트나 데이터베이스와는 전혀 관련이 없음

- 영속(managed)

> 엔티티 매니저를 통해서 엔티티를 영속성 컨텍스트에 저장했다. 영속성 컨텍스트가 관리하는 상태
> em.find() 나 JPQL을 사용해 조회한 엔티티도 영속성 컨텍스트가 관리하는 영속 상태 
> 영속 상태는 식별자 값이 반드시 있어야 한다 

- 준영속(detached)

> 영속성 컨텍스트가 관리하던 영속 상태의 엔티티를 영속성 컨텍스트가 관리하지 않으면 준영속 상태가 된다. 
> em.close(), em.detach(), em.clear() 를 호출해서 영속성 컨텍스트를 초기화해도 영속성 컨테스트가 관라헌 영속 상태의 엔티티는 준영속 상태가 된다. 

- 삭제 (removed)

> 엔티티를 영속성 컨텍스트와 데이터베이스에서 삭제한다. 

&nbsp;
## 영속성 컨텍스트가 엔티티를 관리하면 얻을 수 있는 장점 

- 1차 캐시
- 동일성 보장
- 트랜잭션을 지원하는 쓰기 작업
- 변경 감지
- 지연 로딩 

&nbsp;
## 1차 캐시에서 조회 

em.find() 를 호출하면 우선 1차 캐시에서 식별자 값으로 엔티티를 찾는다. 

&nbsp;
## 데이터베이스에서 조회 

em.find() 를 호출했는데 엔티티가 1차 캐시에 없으면 엔티티 매니저는 데이터베이스를 조회해서 엔티티를 생성한다 그리고 1차 캐시에 저장한 후에 영속 상태의 엔티티를 반환한다. 

&nbsp;
## 영속성 엔티티의 동일성 보장 

```java
Member a = em.find(Member.class, "member1");
Member b = em.find(Member.class, "member1");
```

반복해서 식별자가 같은 엔티티 인스턴스를 조회 시 em.find((Member.class, "member1") 1차 캐시에 있는 같은 엔티티 인스턴스를 반환한다. JPA는 1차 캐시를 통해 REPEATABLE READ 등급의 트랜잭션 격리 수준을 데이터베이스가 아닌 어플리케이션 차원에서 제공한다. 
